name: Deploy Backend with CDK

on:
  push:
    branches: [ master ]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

env:
  AWS_REGION: us-east-2

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
          npm install -g aws-cdk@latest

      - name: Build Images Lambda bundle
        run: |
          cd backend/src/lambda/images

          npm install

          npx tsc

          mkdir -p bundle

          if [ -f "dist/index.js" ]; then
            cp dist/index.js bundle/index.js
          else
            echo "❌ dist/index.js not found"
            exit 1
          fi

          mkdir -p bundle/node_modules
          if [ -d "node_modules/@aws-sdk" ]; then
            cp -r node_modules/@aws-sdk bundle/node_modules/
          fi

          echo "✅ Bundle content:"
          ls -la bundle

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Bootstrap CDK (if needed)
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          cd backend
          npx cdk bootstrap aws://$ACCOUNT_ID/$AWS_REGION || echo "CDK already bootstrapped"

      - name: Build CDK
        run: |
          cd backend
          npm run build

      - name: Deploy Database Stack
        run: |
          cd backend
          npx cdk deploy SaasDatabaseStack --require-approval never --no-previous-parameters

      - name: Deploy Backend Stack
        run: |
          cd backend
          npx cdk deploy SaasBackendStack --require-approval never --no-previous-parameters

      - name: Get Deployment Outputs
        run: |
          cd backend
          echo "=== DEPLOYMENT OUTPUTS ==="
          npx cdk list
          echo ""
          echo "=== BACKEND STACK OUTPUTS ==="
          aws cloudformation describe-stacks \
            --stack-name SaasBackendStack \
            --query "Stacks[0].Outputs" \
            --output table || echo "Could not get outputs"